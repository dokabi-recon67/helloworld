#cloud-config
# HelloWorld Server Auto-Setup Script for Oracle Linux 9
# Upload this file in Oracle Cloud "Management" > "Cloud-init script"

package_update: true
package_upgrade: true

runcmd:
  # ============================================
  # INSTALL PACKAGES (Oracle Linux 9)
  # ============================================
  
  # Enable EPEL repository (needed for stunnel and tor)
  - dnf install -y oracle-epel-release-el9 || dnf install -y epel-release
  
  # Install required packages
  - dnf install -y stunnel openssl openssh-server curl wget firewalld net-tools
  
  # Install Tor
  - dnf install -y tor
  
  # ============================================
  # CREATE DIRECTORIES
  # ============================================
  - mkdir -p /etc/helloworld
  - mkdir -p /var/run/stunnel
  - chown nobody:nobody /var/run/stunnel
  
  # ============================================
  # GENERATE TLS CERTIFICATE (10 year validity)
  # ============================================
  - openssl req -x509 -nodes -days 3650 -newkey rsa:4096 -keyout /etc/helloworld/server.key -out /etc/helloworld/server.pem -subj "/CN=cloudserver"
  - chmod 600 /etc/helloworld/server.key
  - chmod 644 /etc/helloworld/server.pem
  - chown nobody:nobody /etc/helloworld/server.key /etc/helloworld/server.pem
  
  # ============================================
  # CONFIGURE STUNNEL (TLS wrapper on port 443)
  # ============================================
  - |
    cat > /etc/helloworld/stunnel.conf << 'STUNNEL_EOF'
    ; HelloWorld Stunnel Configuration
    pid = /var/run/stunnel/stunnel.pid
    setuid = nobody
    setgid = nobody
    
    ; Logging
    debug = 5
    output = /var/log/stunnel.log
    
    ; TLS settings
    sslVersion = TLSv1.2
    options = NO_SSLv2
    options = NO_SSLv3
    
    ; SSH tunnel service
    [ssh-tunnel]
    accept = 0.0.0.0:443
    connect = 127.0.0.1:22
    cert = /etc/helloworld/server.pem
    key = /etc/helloworld/server.key
    STUNNEL_EOF
  
  # ============================================
  # CREATE SYSTEMD SERVICE
  # ============================================
  - |
    cat > /etc/systemd/system/helloworld.service << 'SERVICE_EOF'
    [Unit]
    Description=HelloWorld Tunnel Server (stunnel)
    After=network.target sshd.service
    Wants=network-online.target
    
    [Service]
    Type=forking
    PIDFile=/var/run/stunnel/stunnel.pid
    ExecStartPre=/bin/mkdir -p /var/run/stunnel
    ExecStartPre=/bin/chown nobody:nobody /var/run/stunnel
    ExecStart=/usr/bin/stunnel /etc/helloworld/stunnel.conf
    ExecReload=/bin/kill -HUP $MAINPID
    Restart=on-failure
    RestartSec=5
    
    [Install]
    WantedBy=multi-user.target
    SERVICE_EOF
  
  # ============================================
  # CONFIGURE SSH (key-only, no passwords)
  # ============================================
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/#PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # ============================================
  # CONFIGURE FIREWALL (open port 443)
  # ============================================
  - systemctl start firewalld
  - systemctl enable firewalld
  - firewall-cmd --permanent --add-port=443/tcp
  - firewall-cmd --permanent --add-port=443/udp
  - firewall-cmd --permanent --add-service=ssh
  - firewall-cmd --reload
  
  # ============================================
  # CONFIGURE GCP FIREWALL (if on Google Cloud)
  # ============================================
  # Detect if running on GCP and configure firewall
  - |
    if curl -s -H "Metadata-Flavor: Google" --max-time 2 http://metadata.google.internal/computeMetadata/v1/instance/id >/dev/null 2>&1; then
      echo "Detected Google Cloud Platform - configuring firewall..."
      # Try to use gcloud if available (requires gcloud CLI installed on VM)
      if command -v gcloud >/dev/null 2>&1; then
        PROJECT=$(gcloud config get-value project 2>/dev/null)
        if [ -n "$PROJECT" ]; then
          # Check if rule exists, create if not
          if ! gcloud compute firewall-rules list --filter="name=allow-helloworld-443" --format="value(name)" 2>/dev/null | grep -q "allow-helloworld-443"; then
            gcloud compute firewall-rules create allow-helloworld-443 \
              --allow tcp:443 \
              --source-ranges 0.0.0.0/0 \
              --description "Allow HelloWorld stunnel on port 443" \
              --direction INGRESS 2>/dev/null || echo "GCP firewall: gcloud command failed (may need to run from PC)"
          else
            echo "GCP firewall rule already exists"
          fi
        else
          echo "GCP firewall: gcloud not configured (will need manual setup)"
        fi
      else
        echo "GCP firewall: gcloud CLI not available on VM"
        echo "To configure GCP firewall, run this on your PC:"
        echo "gcloud compute firewall-rules create allow-helloworld-443 --allow tcp:443 --source-ranges 0.0.0.0/0 --description 'Allow HelloWorld stunnel on port 443'"
      fi
    else
      echo "Not running on GCP (or metadata service unavailable)"
    fi
  
  # ============================================
  # CONFIGURE TOR (for anonymous exit mode)
  # ============================================
  - |
    cat >> /etc/tor/torrc << 'TOR_EOF'
    
    # HelloWorld Tor Configuration
    ControlPort 9051
    CookieAuthentication 0
    SocksPort 9050
    TOR_EOF
  - systemctl enable tor
  - systemctl start tor
  
  # ============================================
  # START HELLOWORLD SERVICE
  # ============================================
  - systemctl daemon-reload
  - systemctl enable helloworld
  - systemctl start helloworld
  
  # ============================================
  # CREATE HELPER SCRIPTS
  # ============================================
  
  # Status script
  - |
    cat > /usr/local/bin/helloworld-status << 'STATUS_EOF'
    #!/bin/bash
    echo "==========================================="
    echo "       HelloWorld Server Status"
    echo "==========================================="
    echo ""
    echo "Services:"
    echo "  Stunnel (TLS):  $(systemctl is-active helloworld)"
    echo "  SSH:            $(systemctl is-active sshd)"
    echo "  Tor:            $(systemctl is-active tor)"
    echo "  Firewall:       $(systemctl is-active firewalld)"
    echo ""
    echo "Network:"
    echo "  Public IPv4:    $(curl -s -4 https://api.ipify.org 2>/dev/null || echo 'N/A')"
    echo "  Public IPv6:    $(curl -s -6 https://api6.ipify.org 2>/dev/null || echo 'N/A')"
    echo "  Tor IP:         $(curl -s --socks5 127.0.0.1:9050 https://api.ipify.org 2>/dev/null || echo 'Not connected')"
    echo ""
    echo "Port 443:"
    ss -tlnp | grep :443 || echo "  Not listening"
    echo ""
    echo "==========================================="
    STATUS_EOF
  - chmod +x /usr/local/bin/helloworld-status
  
  # Tor rotate script
  - |
    cat > /usr/local/bin/helloworld-rotate << 'ROTATE_EOF'
    #!/bin/bash
    echo "Requesting new Tor circuit..."
    echo -e 'AUTHENTICATE ""\r\nSIGNAL NEWNYM\r\nQUIT' | nc 127.0.0.1 9051
    sleep 3
    echo "New Tor IP: $(curl -s --socks5 127.0.0.1:9050 https://api.ipify.org)"
    ROTATE_EOF
  - chmod +x /usr/local/bin/helloworld-rotate
  
  # Install netcat for Tor control
  - dnf install -y nc nmap-ncat || yum install -y nc
  
  # ============================================
  # FINAL SETUP
  # ============================================
  - touch /var/log/helloworld-setup.log
  - echo "==========================================" >> /var/log/helloworld-setup.log
  - echo "HelloWorld setup completed at $(date)" >> /var/log/helloworld-setup.log
  - echo "Public IP: $(curl -s https://api.ipify.org)" >> /var/log/helloworld-setup.log
  - echo "==========================================" >> /var/log/helloworld-setup.log
  
  # Run status check
  - /usr/local/bin/helloworld-status >> /var/log/helloworld-setup.log

final_message: |
  =============================================
  HelloWorld Server Setup Complete!
  
  Connect to this server on port 443
  Run 'helloworld-status' to check status
  Run 'helloworld-rotate' to get new Tor IP
  =============================================
